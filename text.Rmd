---
title: <div style="text-align:center"> **Proyecto Business Performance Analysis**<div/>
author: <small> Jose Alejandro Miranda, Maria Jesus Palero, Jaime Andres Salazar y Paola Rita Villar.</small>
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    collapsed: true
    number_sections: false
    theme: cerulean
    fig_width: 7
    fig_height: 6
    fig_caption: true
---

##  **1. Preparacion de los datos**

Librerias a utilizar:

```{r Librerias, warning=FALSE, message = FALSE}
library(tidyverse) # tidyr, dplyr, ggplot2, purrr..... 
library(DescTools) #Herramientas para estadística descriptiva y análisis de datos
library(psych) #Herramientas de entrada de datos y análisis descriptivo.
library(scales) #Herramienta complemento de "ggplot2"
library (reshape2) #Para uso de función melt()




library(ggpubr)

```

Durante todo el analisis se trabaja con la base de datos suministrada "`Dataset_Compradores.csv`", la cual, para su estandarizacion, se extrae desde URL. Ademas, por indicaciones durante clase, la ultima variable `Exited` no se  tiene en cuenta.

```{r datos}

data_ori <- read.csv("https://raw.githubusercontent.com/Lermaa2/ProjectoFinal-BPA/68c182ad59e0039875994b11acfcd40a66949acd/Dataset_Compradores.csv"
                 ,dec=".")

dat <- data_ori[2:13]; glimpse(dat);tail(dat[,1:4])

```
Se observa que existen 10000 entradas, no existen ni notas ni pie de paginas que puedan requerir ser eliminados antes del analisis. 

## **2. Describir de manera grafica y estadistica las variables de la base de datos**

Ahora, se definie cada variable y se indica el tipo de dato/variable con el que se trabaja, agrupandolas en dos grupos, categoricas y cualitativas.

##### **Categoricas/Cualitativas:**

* `CustomerId`      : Identifiacion del cliente. Se transforma a factor. (`factor`/nominal).

* `Surname`         : Apellido de los clientes. Se transforma a factor. (`factor`/nominal).

* `Geography`       : Pais de origen de cada cliente. Se transforma a factor. (`factor`/nominal)

* `Gender`         : Genero de cada cliente. Se transforma a factor. (`factor`/nominal)

* `HasCrCard`       : Posee/ No posee (1/0) Tarjeta de Credito. Se transforma a factor. (`factor``/nominal).

* `IsActiveMember`  : Indica si el cliente esta/no esta (1/0) activo en la entidad. 

Todas se transforman a factor (`factor`/nominal).

##### **Cuantitativas:**

* `Age`             : Edad del cliente. (`int`/discreta).

* `Tenure`          : Meses restantes para el pago total de la deuda. (`int`/discreta).

* `CreditScore`     : Score de Credito, valoracion de cada cliente basado en su historial crediticio. (`int`/discreta).

* `EstimatedSalary` : Salario estimado del cliente. (`num`/continua).

* `Balance`         : Deuda pendiente de pago. (`num`/continua).

* `NumOfProducts`   : Productos bancarios de cada cliente. (`int`discreta).

El valor `CreditScore` se usa para asignar niveles a los clientes que dependen del modelo de cada banco, pero se suele usar:

* 350 ~ 579 - `poor`

* 580 ~ 669 - `fair`

* 670 ~ 739 - `good` 

* 740 ~ 799 - `very_good`

* Mayor que 800 - `excellent`

Para el analisis, se decide agregar la variable categorica `CreditCat` (`ord`/ordinal). Adicional a los cambios de clase mencionados, se busca conocer si existen valores nulos o NA:

```{r data, warning=FALSE, message = FALSE}
dat <-  data_ori[2:13] %>% 
  mutate( CreditCat= case_when(CreditScore < 580 ~ 1,
        CreditScore >= 580 & CreditScore < 669 ~ 2,
        CreditScore >= 669 & CreditScore < 739 ~ 3,
        CreditScore >= 739 & CreditScore < 799 ~ 4,
        CreditScore >= 799 ~ 5,
        TRUE ~ 0)) %>% 
  select(CustomerId, Surname,Geography,Gender, 
         IsActiveMember, HasCrCard, CreditCat,
         CreditScore, Age, EstimatedSalary, Tenure , 
         Balance, NumOfProducts) %>% 
  mutate(across(c(CustomerId,
                  Surname,
                  Geography,
                  Gender,
                  IsActiveMember,
                  HasCrCard,
                  CreditCat),
                factor)) %>% 
  rename_if(is.numeric,~paste("cu",.x,sep = "_") ) %>% 
  rename_if(negate(is.numeric),~paste("ca",.x,sep = "_") )
##* Para `CreditCat`:
dat$ca_CreditCat <- factor(dat$ca_CreditCat, 
                        labels = c("poor", "fair",
                                   "good", "very_good",
                                   "excellent"),ordered = T);glimpse(dat)
##* Se da formato canonico a la tabla de datos, es decir, se muestra una fila para cada valor observado (medido). 
dat_long = melt(dat);glimpse(dat_long)
```
Para las variables cuantitativas, se indican los estadisticos basicos, al igual que la visualizacion de la dispersion y centralidad:

```{r num ,fig.height = 4.5, message=FALSE}
dat %>% 
  select(starts_with("cu")) %>% 
  summary.data.frame()
## Mas estadisticos basicos
dat %>% 
  select(starts_with("cu")) %>% 
  describe()

dat %>% 
  select(starts_with("cu")) %>% 
  summarise(across(everything(),~ks.test(.,"pnorm")$p.value))

## Grafica


##* Box
dat_long %>% 
  ggplot(aes(variable, value,fill=variable))+
  geom_boxplot()+
  geom_point(data=dat_long %>% 
               group_by(variable) %>% 
               summarise(mean= mean(value)), 
             aes(variable,mean), shape=8)+
  facet_wrap(.~variable, scales = "free")+
  theme_bw()+
  theme(legend.position='none')


##* Density
dat_long %>% 
  select(variable,value) %>% 
  ggplot(aes(value,group=variable,fill=variable, alpha=0.7))+
  geom_density(kernel = "gaussian")+
  
  geom_vline(data = dat_long %>%
               group_by(variable) %>% 
               summarise(mean= mean(value)),
             aes(xintercept = mean))+
  
  facet_wrap(.~variable, scales = "free")+
  theme_bw()+
<<<<<<< HEAD
  theme(legend.position='none')
```

Para representar las variables cuantitativas, se ha seleccionado el grafico boxplot donde se observan los valores extremos, el rango desde el primer hasta el tercer cuartil,la mediana y se ha representado la media mediante un asterisco.

Nuevamente, no se identifican valores NaN. Mas adelante se profundizara en los estadisticos.

En cuanto a las variables categoricas: 

=======
  theme(legend.position='top')
```

Nuevamente, no se identifican valores NaN. Mas adelante se profundizará en los estadisticos.

En cuanto a las variables categóricas: 

>>>>>>> 9f00a6aa66611583a6c3f942996e7619b15d0f4e
```{r summ cat,fig.height = 4.5, message=FALSE}
##* Frecuencias
dat %>% 
  select(starts_with("ca") & !ca_Surname) %>% 
  summary()
```
De esta manera, se  pueden conocer los valores y frecuencias de cada una de las variables categoricas. Ademas, cada observacion/fila tiene un `CustomerId` unico (es decir, datos de clientes diferentes) y en ningun caso se identifican entradas NaN.

<<<<<<< HEAD
## **3. Llevar a cabo un analisis estadistico en R e interpretar los resultados**

##### **Realizar un analisis de comparacion, siendo la hipotesis inicial: El salario de los consumidores es igual en los diferentes paises donde se han recogido los datos**

```{r}
anova(lm(dat$cu_EstimatedSalary~dat$ca_Geography))
```
H~0~=El salario de los consumidores es igual en los diferentes paises donde se han recogido los datos.

H~1~=El salario de los consumidores no es igual en los diferentes paises donde se han recogido los datos.

Segun el analisis anova, el p-value es de 0.5584, al ser mayor a 0.05, no se rechaza la hipotesis nula, por tanto, la diferencia del salario no es significativamente diferente en alguno de los paises.

```{r}
medias<-dat %>% 
  select(ca_Geography,cu_EstimatedSalary) %>% 
  group_by(ca_Geography) %>% 
  summarise(mean=mean(cu_EstimatedSalary))
```
=======
```{r fq cate, fig.height = 4.4, fig.width =8}

##* Geography
plot_Geo <-dat %>% 
  count(ca_Geography) %>% 
  mutate(prop = percent(prop.table(n))) %>% 
  ggplot(aes(ca_Geography,n,label= prop,fill= ca_Geography)) +
  geom_col(color="black")+
  geom_text(check_overlap = TRUE,
            position = position_stack(vjust = 0.5),
            size=3)+
  theme_bw()+
  scale_fill_manual("", values = c("France" = "#c90000", 
                                   "Germany" = "#eb9100", 
                                   "Spain" = "#fff700"))+
  theme(legend.position='none')

##* Gender
plot_Gender <-dat %>% 
  count(ca_Gender) %>% 
  mutate(prop = percent(prop.table(n))) %>% 
  ggplot(aes(ca_Gender,n,label= prop,fill= ca_Gender)) +
  geom_col(color="black")+
  geom_text(check_overlap = TRUE,
            position = position_stack(vjust = 0.5),
            size=3)+
  theme_bw()+
  theme(legend.position='none')

##* IsActiveMember
plot_Act <-dat %>% 
  count(ca_IsActiveMember) %>% 
  mutate(prop = percent(prop.table(n))) %>% 
  ggplot(aes(ca_IsActiveMember,n,label= prop,
             fill=ca_IsActiveMember)) +
  geom_col(color="black")+
  geom_text(check_overlap = TRUE,
            position = position_stack(vjust = 0.5),
            size=3)+
  theme_bw()  + 
  scale_fill_manual("", values = c("0" = "#e00000", 
                                   "1" = "#087d00"))+
  theme(legend.position='none')

##* HasCrCard
plot_HCre <-dat %>% 
  count(ca_HasCrCard) %>% 
  mutate(prop = percent(prop.table(n))) %>% 
  ggplot(aes(ca_HasCrCard,n,label= prop,fill= ca_HasCrCard)) +
  geom_col(color="black")+
  geom_text(check_overlap = TRUE,
            position = position_stack(vjust = 0.5),
            size=3)+
  theme_bw()+
  scale_fill_manual("", values = c("0" = "#e00000", 
                                 "1" = "#087d00"))+
  theme(legend.position='none')

##* CreditCat
plot_CrCat <-dat %>% 
  count(ca_CreditCat) %>% 
  mutate(prop = percent(prop.table(n))) %>% 
  ggplot(aes(ca_CreditCat,n,label= prop,fill= ca_CreditCat)) +
  geom_col(color="black")+
  geom_text(check_overlap = TRUE,
            position = position_stack(vjust = 0.5),
            size=3)+
  theme_bw()+
  theme(legend.position='none')


##* Visualización

ggarrange(plot_Geo, plot_CrCat,
          ncol = 2, nrow = 1)

ggarrange(plot_Gender, plot_Act, plot_HCre,
          ncol = 3, nrow = 1)

```

De esta manera, se  puede conocer los valores y frecuencias de cada una de las variables categóricas. Además, cada observación/fila tiene un `CustomerId` único (es decir, datos de clientes diferentes) y en ningún caso se identificaron entradas NaN.




>>>>>>> 9f00a6aa66611583a6c3f942996e7619b15d0f4e
```{r}
ggplot(dat, aes(ca_Geography,cu_EstimatedSalary,fill=ca_Geography))+
  geom_boxplot()+
  geom_point(data=medias,aes(ca_Geography,mean),shape=2)

```

Se observa que los salarios no son significativamente diferentes.






















